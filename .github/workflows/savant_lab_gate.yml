name: Savant LAB Gate

on:
  push:
    branches: [ "main" ]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # cada 6 horas (observabilidad)

jobs:
  lab-gate:
    runs-on: ubuntu-latest

    env:
      ARTIFACTS_DIR: artifacts/lab
      SAVANT_TIMEOUT: "30"
      SAVANT_BENCH_N: "50"
      # OJO: usa el secret de repositorio "SAVANT_BASE_URL" (URL base del API de Savant).
      # Si no está definido el secret, el step "Run LAB gate" usará el fallback público.
      SAVANT_BASE_URL: ${{ secrets.SAVANT_BASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r lab/requirements-lab.txt

        - name: Run LAB gate
          run: |
            # fallback si no está el secret
            if [ -z "${SAVANT_BASE_URL}" ]; then
              echo "Aviso: SAVANT_BASE_URL no está configurado como secret; usando fallback https://antonypamo-apisavant2.hf.space"
              export SAVANT_BASE_URL="https://antonypamo-apisavant2.hf.space"
            fi
            python lab/savant_lab_runner.py

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: savant-lab-artifacts
          path: artifacts/lab
